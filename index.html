<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map</title>

    <!-- leaflet css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #title {
            width: 100%;
            height: 2vh;
        }
    </style>

    <style>
        #map { 
            width: 100%;
            height: 100vh; 
        }
    </style>

</head>

<body>


    <div id="title"></div> Leaflet Map </div>

    <!-- div element which holds the map -->
    <div id="map"></div>
</body>

</html>

<!-- leaflet js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- geojson files -->
<script src="./data/London.js"></script>

<script>

    /*===========================================================
                        Initialisation
    ===========================================================*/
    
    // initialise the map and set its view to a geographical location (coordinates) and zoom level
    var map = L.map('map').setView([54.217, -4.558], 6);




    /*===========================================================
                            Databricks Queries
    ===========================================================*/
    
    // Define queries, location of markers to be created and icon
    const queries = [
        {
            name: 'Marker 1',
            query: 'SELECT * FROM prod.warehouse.brands LIMIT 10',
            marker: { latitude: 52.468926, longitude: -1.888867, icon: 'img/red_marker.png' },
        }
    ];

    // define function to fetch data and create markers
    async function fetchDataAndCreateMarkers() {
        for (const queryInfo of queries) {
            try {
                const response = await fetch('https://dbc-25dae16e-9b76.cloud.databricks.com/sql/1.0/endpoints/6326b79d23570977', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer dapi3509b026e18ba37790d3598c5007d9b5',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: 'sql',
                        query: queryInfo.query,
                        context: {
                            'warehouse_id': '6326b79d23570977',
                            'catalog': 'prod',
                            'schema': 'warehouse'
                        }
                    }),
                });

                const data = await response.json();
                console.log(data);

                // Process data and create markers
                const { latitude, longitude } = queryInfo.marker;
                const marker = L.marker([latitude, longitude], { icon: L.icon({ iconUrl: queryInfo.marker.icon }) })
                    .bindPopup(`<b>${queryInfo.name}</b><br>${JSON.stringify(data)}`);

                marker.addTo(map);
            } catch (error) {
                console.error(`Error fetching data for ${queryInfo.name}:`, error);
            }
        }
    }


    /*===========================================================
                            TILE LAYER
    ===========================================================*/

    // add tile layer to map (osm layer)
    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    })
    osm.addTo(map)

    // osm hot layer
    var osmHOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team hosted by OpenStreetMap France'
    });

    /* 
    // We can add additional layers to the map
    https://leaflet-extras.github.io/leaflet-providers/preview/
    */


    /*===========================================================
                            MARKER LAYER
    ===========================================================*/

    // layer groups
    var london = L.marker([51.506, -0.125])
    var manchester = L.marker([53.480, -2.244])
    
    var cities = L.layerGroup([london, manchester])

    /* 
    // We can add various markers, circles, polygons, popups etc

    // marker
    var marker = L.marker([51.5, -0.09]).addTo(map);

    // marker sourced from imag
    var myIcon = L.icon({
        iconUrl: 'img/red_marker_png',
        iconSize: [40,40]
    })
    var marker = L.marker([51.5, -0.09], {icon:myIcon}).addTo(map);

    // circle
    var circle = L.circle([51.508, -0.11], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 500
    }).addTo(map);

    // var polygon = L.polygon([
        [51.509, -0.08],
        [51.503, -0.06],
        [51.51, -0.047]
    ]).addTo(map);

    // popups
    marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
    circle.bindPopup("I am a circle.");
    polygon.bindPopup("I am a polygon.");
    */

    /*===========================================================
                            GEOJSON LAYER
    ===========================================================*/

    L.geoJSON(londonJSON).addTo(map)


    /*===========================================================
                            LAYER CONTROL
    ===========================================================*/

    // objects to contain base layers and overlays (markers etc)
    var baseMaps = {
        "OpenStreetMap": osm,
        "OpenStreetMap.HOT": osmHOT
    };

    var overlayMaps = {
        "Cities": cities
    }; 

    // Layers control
    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    fetchDataAndCreateMarkers();

</script>